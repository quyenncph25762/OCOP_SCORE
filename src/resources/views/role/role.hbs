{{> header}}
<div class="content-wrapper" id="toastRole">
    <div class="container-fluid">
        <div class="row" style="max-width: 100%; display: contents;">
            <ul class="search-customer"
                style="list-style: none; display:flex; justify-content: space-between; align-items: center;">
                <button class="btn btn-danger btnDeleteAll btnDisabled" style="float: left;">Xóa mục đã chọn</button>
                <div class="import_customer_button"
                    style="list-style: none; display:flex; justify-content: space-between; align-items: center;">
                    <button class="btn btn-info" data-toggle="modal" data-target="#exampleModal">Thêm mới</button>
                </div>
                {{> modalRole}}
            </ul>
            </li>
            </ul>
        </div>
    </div>
    {{!-- body --}}
    <div class="row" style="display: contents;">
        <div class="col-lg-6" style="max-width: 100%;">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items">
                        <h5 class="card-title">Danh sách vai trò</h5>
                        <span class="d-inline-block ml-3" tabindex="0" data-toggle="tooltip" title="Thùng rác của bạn">
                            <a href="/role/trash">
                                <ion-icon name="trash-outline">
                                </ion-icon>
                            </a>
                        </span>
                    </div>
                    <div class="table-responsive">
                        <table id="myTable" class="table datatables table-bordered table-hover table-striped">
                            <thead>
                                <tr>
                                    <th {{#ifCond Role.length 0}}hidden{{/ifCond}}>
                                        <div class="checkbox-wrapper-42 checkbox">
                                            <input id="checkAll" type="checkbox" class="check" />
                                            <label class="cbx" for="checkAll"></label>
                                        </div>
                                    </th>
                                    <th hidden>#</th>
                                    <th>Active</th>
                                    <th>Tên vai trò</th>
                                    <th>Ghi chú</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each Role}}
                                <tr>
                                    <td>
                                        <div class="checkbox-wrapper-42 checkbox">
                                            <input id="cbx-42{{this._id}}" type="checkbox" class="check"
                                                data-idCheckBox="{{this._id}}" />
                                            <label class="cbx" for="cbx-42{{this._id}}"></label>
                                        </div>
                                    </td>
                                    <td hidden>{{@index}}</td>
                                    <td>
                                        {{#ifCond this.status 1}}
                                        <div class="active"></div>
                                        {{else}}
                                        <div class="inactive"></div>
                                        {{/ifCond}}
                                    </td>
                                    <td>{{this.title}}</td>
                                    <td>{{this.note}}</td>
                                    <td scope="row" style="display: flex;">
                                        <div class="action_center">

                                            <button
                                                style="background-color: transparent;border: none ;cursor: pointer;">
                                                <span class="d-inline-block" tabindex="0" data-toggle="tooltip"
                                                    title="Chỉnh sửa">
                                                    <ion-icon name="create-outline" data-toggle="modal"
                                                        data-target="#exampleModal{{this._id}}"
                                                        id="permission_{{this._id}} " data="{{this._id}}"></ion-icon>
                                                </span>
                                            </button>
                                            {{> modalRole}}
                                        </div>
                                        <div class="delete_action">
                                            <span class="d-inline-block" tabindex="0" data-toggle="tooltip"
                                                title="Xóa chủ thể">
                                                <ion-icon id="icon_moveToTrash" name="trash-outline"
                                                    data-id="{{this._id}}">
                                                </ion-icon>
                                            </span>
                                        </div>
                                    </td>
                                </tr>
                                {{/each }}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div><!--End Row-->
    </div>
    <!-- End container-fluid-->
</div><!--End content-wrapper-->
{{> footer}}

{{!--
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> --}}
<script src="/assets/js/custom.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
<script>

    // thêm permission
    $(function () {
        var data = [
            { "id": "Dashboard", "parent": "#", "text": "Dashbroad" },
            { "id": "Structure", "parent": "#", "text": "Cơ cấu tổ chức" },
            { "id": "Employee", "parent": "#", "text": "Quản lý cán bộ" },
            { "id": "Year", "parent": "#", "text": "Năm đánh giá" },
            { "id": "Customer", "parent": "#", "text": "Quản lý chủ thể" },
            { "id": "Product", "parent": "#", "text": "Quản lý sản phẩm" },
            { "id": "Search", "parent": "#", "text": "Tra cứu hồ sơ OCOP" },
            { "id": "Committee", "parent": "#", "text": "Hội đồng chấm" },
            { "id": "Score", "parent": "#", "text": "Chấm điểm OCOP" },
            { "id": "Category", "parent": "#", "text": "Danh mục" },
            { "id": "Manage", "parent": "#", "text": "Quản trị*" },
        ];

        $('#tree').jstree({

            'core': {
                'data': data,

            },
            'plugins': ['checkbox']
        });

    });

    const getAllIdPermission = document.querySelectorAll("[id^=permission_]")
    getAllIdPermission.forEach(id => {
        var Id = id.getAttribute('data')

        id.addEventListener('click', function () {
            $.ajax({
                url: `/role/${Id}/permission`,
                type: 'GET'
            })
                .then(results => {
                    // update permission
                    $(function () {
                        var data = [
                            { "id": "Dashboard", "parent": "#", "text": "Dashbroad" },
                            { "id": "Structure", "parent": "#", "text": "Cơ cấu tổ chức" },
                            { "id": "Employee", "parent": "#", "text": "Quản lý cán bộ" },
                            { "id": "Year", "parent": "#", "text": "Năm đánh giá" },
                            { "id": "Customer", "parent": "#", "text": "Quản lý chủ thể" },
                            { "id": "Product", "parent": "#", "text": "Quản lý sản phẩm" },
                            { "id": "Search", "parent": "#", "text": "Tra cứu hồ sơ OCOP" },
                            { "id": "Committee", "parent": "#", "text": "Hội đồng chấm" },
                            { "id": "Score", "parent": "#", "text": "Chấm điểm OCOP" },
                            { "id": "Category", "parent": "#", "text": "Danh mục" },
                            { "id": "Manage", "parent": "#", "text": "Quản trị*" },
                        ];

                        $(`#tree${Id}`).jstree({
                            'plugins': ['checkbox'],
                            'core': {
                                'data': data,
                                'check_callback': true // allow new nodes to be added
                            }
                        }).bind('loaded.jstree', function () {
                            results.forEach(function (item) {

                                $(`#tree${Id}`).jstree('select_node', item.NamePermission);
                            });

                        });
                    })
                        .catch(err => {
                            console.log('Error', err)
                        })
                })
        })

    })

</script>

<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'UA-56159088-1');
    // checkbox All
    $("#checkAll").click(function (e) {
        $(".check").prop('checked', $(this).prop('checked'));
    });
</script>
<script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const toastData = localStorage.getItem('toast');
        if (toastData) {
            const toast = JSON.parse(toastData);
            $.toast(toast);
            localStorage.removeItem('toast');
        }
        const btnTrash = document.querySelectorAll('#icon_moveToTrash');
        for (let btn of btnTrash) {
            btn.addEventListener("click", (event) => {
                event.preventDefault();
                $.confirm({
                    title: '<ion-icon name="trash-bin-outline"></ion-icon>',
                    content: 'Bạn có chắc chắn muốn xóa ?',
                    buttons: {
                        confirm: {
                            text: 'Confirm',
                            btnClass: 'btn-red',
                            action: function () {
                                // Lấy ID của mục cần xóa từ thuộc tính data-id của nút
                                const id = event.target.dataset.id;

                                // Gọi API xóa mục
                                fetch(`/role/removeToTrash/${id}`, {
                                    method: 'DELETE'
                                }).then(response => {
                                    if (response.ok) {
                                        localStorage.setItem('toast', JSON.stringify({
                                            position: "top-right",
                                            heading: 'Xóa thành công',
                                            text: 'Đã xóa thành công thành công',
                                            icon: 'success',
                                            loader: true,
                                            loaderBg: '#9EC600',
                                            showHideTransition: 'slide',
                                            stack: 4
                                        }));
                                        window.location.reload()
                                    } else {
                                        localStorage.setItem('toast', JSON.stringify({
                                            position: "top-right",
                                            heading: 'Xóa không thành công',
                                            text: 'Đã xảy ra lỗi khi xóa mục',
                                            icon: 'error',
                                            loader: true,
                                            loaderBg: '#9EC600',
                                            showHideTransition: 'slide'
                                        }));
                                    }
                                }).catch(error => {
                                    $.alert('Đã hủy');
                                });
                            }
                        },
                        cancel: function () {
                            $.alert('Đã hủy!');
                        }
                    }
                });
            });
        }
        //removeAll
        const btnsCheck = document.querySelectorAll(".check")
        const btnDeleteAll = document.querySelector(".btnDeleteAll")
        const btnDisabled = document.querySelector(".btnDisabled")
        //Chưa checked thì disbale nút xóa all
        let count = 0
        const checkBtnDisabled = () => {
            if (count === 0) {
                btnDisabled.setAttribute("disabled", true)
            } else {
                btnDisabled.removeAttribute("disabled")
            }
        }
        for (let checked of btnsCheck) {
            checkBtnDisabled()
            checked.addEventListener("click", (e) => {
                if (checked.checked) {
                    count++
                } else {
                    count--
                }
                checkBtnDisabled()
            })
        }
        //Xoa nhieu
        btnDeleteAll.addEventListener("click", async (e) => {
            e.preventDefault();
            $.confirm({
                title: '<ion-icon name="trash-bin-outline"></ion-icon>',
                content: 'Xác nhận xóa những đối tượng bạn đã chọn ?',
                buttons: {
                    confirm: {
                        text: 'Confirm',
                        btnClass: 'btn-red',
                        action: function () {
                            for (let btnCheck of btnsCheck) {
                                if (btnCheck.checked) {
                                    const id = btnCheck.dataset.idcheckbox
                                    fetch(`/role/removeToTrash/${id}`, {
                                        method: 'DELETE'
                                    })
                                }
                            }
                            localStorage.setItem('toast', JSON.stringify({
                                position: "top-right",
                                heading: 'Xóa thành công',
                                text: 'Đã xóa thành công thành công',
                                icon: 'success',
                                loader: true,
                                loaderBg: '#9EC600',
                                showHideTransition: 'slide',
                                stack: 4
                            }));
                            window.location.reload()
                        }
                    },
                    cancel: function () {
                        $.alert('Đã hủy');
                    }
                }
            });
        })
    });



</script>