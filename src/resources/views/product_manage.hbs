<style>
  .listGallery {
    display: flex;
    flex-direction: column;
    align-items: start;
  }

  .gallery-items:hover {
    color: red;
    font-size: 14px;
  }


  .activeTabs {
    background-color: #333333;
    color: white;
  }

  .file-item a {
    font-size: 12px;
  }

  @media screen and (min-width: 768px) and (max-width: 1180px) {
    .modal-content {
      min-width: 750px !important;
      height: auto;
      overflow-y: auto;
    }

    #myTable {
      font-size: 12px !important;
    }

    #myTable {
      width: 100%;
    }

    .row-content {
      height: auto !important;
    }

    .form-row {
      margin-bottom: 80px;
    }

    .file-upload {
      margin-bottom: 40px;
    }
  }

  @media screen and (min-width:1180px) {
    .codeColumn {
      display: none !important;
    }

    .modal-content {
      min-width: 1200px !important;
    }

  }
</style>
{{> header}}
<div class="content-wrapper">
  <div class="container-fluid">
    <div class="row" style="max-width: 100%; display: contents;">
      <ul class="search-customer"
        style="list-style: none; display:flex; justify-content: space-between; align-items: center;">
        <button class="btn btn-danger btnDeleteAll btnDisabled" style="float: left;">Xóa mục đã chọn</button>
        <div class="import_customer_button"
          style="list-style: none; display:flex; justify-content: space-between; align-items: center;">
          <button class="btn btn-info" id="buttonAddProduct" data-toggle="modal" data-target="#exampleModalAdd">Thêm
            mới</button>
        </div>
        {{> modalProduct}}
      </ul>
      </li>
      </ul>
    </div>
  </div>
  <!-- End container-fluid-->

  <div class="row" style="display: contents;">
    <div class="col-lg-6" style="max-width: 100%;">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items">
            <h5 class="card-title">Danh sách sản phẩm</h5>
            <span class="d-inline-block ml-3" tabindex="0" data-toggle="tooltip" title="Thùng rác của bạn">
              <a href="/product-manage/trash">
                <ion-icon name="trash-outline">
                </ion-icon>
              </a>
            </span>
          </div>
          <div class="table-responsive">
            <table id="myTable" class="table datatables table-bordered table-hover table-striped">
              <thead>
                <tr>
                  <th>
                    <div class="checkbox" {{#ifCond Product.length 0}}hidden{{/ifCond}}>
                      <div class="checkbox-wrapper-42 checkbox">
                        <input id="checkAll" type="checkbox" class="check" />
                        <label class="cbx" for="checkAll"></label>
                      </div>
                    </div>
                  </th>
                  <th scope="col" style="display: none;">Mã sản phẩm</th>
                  <th scope="col">Tên sản phẩm</th>
                  <th scope="col">Nhóm sản phẩm</th>
                  <th scope="col">Năm đánh giá</th>
                  <th scope="col">Trạng thái</th>
                  <th scope="col">Hành động</th>
                </tr>
              </thead>
              <tbody>
                {{#each Product}}
                <tr>
                  <td>
                    <div class="checkbox-wrapper-42 checkbox">
                      <input id="cbx-42{{this._id}}" type="checkbox" class="check" data-idCheckBox="{{this._id}}" />
                      <label class="cbx" for="cbx-42{{this._id}}"></label>
                    </div>
                  </td>
                  <td class="codeColumn" style="display: none;">{{this.Code}}</td>
                  <td>
                    <div style="display: flex;flex-direction: column;">
                      <p class="text-hightlight" style="font-size: 14px;font-weight: 600;">{{this.Name}}</p>
                      {{#ifCond customer_IsDeleted 0}}
                      <p style="color: #B5B5C3; font-weight: 550;text-wrap: wrap;">{{this.customer_name}}</p>
                      {{else}}
                      <p class="text-hightlight" style=">Không xác định</p>
                      {{/ifCond}}
                    </div>
                  </td>
                  {{#ifCond productgroup_IsDeleted 0}}
                  <td>
                    <p class=" text-overhidden">
                        {{this.productGroup_name}}
                      </p>
                  </td>
                  {{else}}
                  <td class="text-hightlight" style=">Không xác định</td>
                  {{/ifCond}}
                  {{#ifCond yearreview_IsDeleted 0}}
                  <td>{{this.yearName}}</td>
                  {{else}}
                  <td class=" text-hightlight" style=">Không xác định</td>
                  {{/ifCond}}
                  {{#ifCond this.Status 1}}
                  <td>
                    <p class=" statusLabelSuccess" for="" style="">Đã duyệt</p>
                  </td>
                  {{else}}
                  <td>
                    <p class="statusLabelDanger" for="" style="">Chờ duyệt</p>
                  </td>
                  {{/ifCond}}
                  {{!-- icons --}}
                  <td scope="row">
                    <span class="d-inline-block ml-3" tabindex="0" data-toggle="tooltip" title="Chỉnh sửa">
                      <ion-icon name="create-outline" data-toggle="modal"
                        data-target="#exampleModal{{this._id}}"></ion-icon>
                    </span>
                    {{!-- modal --}}
                    <div class="modal fade" id="exampleModal{{this._id}}" tabindex="-1" role="dialog"
                      aria-labelledby="exampleModalLabel" aria-hidden="true">
                      <div class="modal-dialog modal__size" role="document">
                        <div class="modal-content modal-product" style="100%">
                          <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Cập nhật sản phẩm</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                              <span aria-hidden="true">&times;</span>
                            </button>
                          </div>
                          <div class="modal-body" class="width: 100%">
                            <form enctype="multipart/form-data">
                              <div class="row row-content">
                                <div class="form-row col-sm-12 col-md-12 col-xl-3"
                                  style="display: flex;flex-direction: column; text-align: center;">
                                  <h1 style="font-size: 16px; text-align: center;font-weight: 600;">Ảnh sản phẩm</h1>
                                  <div class="file-upload" style="cursor: pointer;">
                                    <div>
                                      {{!-- avatar --}}
                                      <input type='file' name="Avatar" id="avatar{{this._id}}" style="display: none;">
                                      <input type="text" value="{{this.Avatar}}" name="Avatar" hidden>
                                      <div class="drag-text" onclick="onclickImage(`{{this._id}}`)">
                                        <img style="width: 100%; height: 100%;object-fit: cover;"
                                          id="avatarPreview{{this._id}}" class="file-upload-image"
                                          src="{{this.Avatar}}" />
                                      </div>
                                    </div>
                                    <div onclick="handleShowFormProductUpdate('{{this._id}}')"
                                      class="d-flex align-items-center justify-content-center p-2 mt-3 hover-effect activeTabs boxFormProductUpdate{{this._id}}"
                                      style="cursor: pointer; border-radius: 10px;">
                                      <ion-icon name="menu-outline"></ion-icon>
                                      <span class="ml-2">Thông tin chung</span>
                                    </div>
                                    <div onclick="handleShowListCitationUpdate('{{this._id}}')"
                                      class="d-flex align-items-center justify-content-center mt-2 p-2 hover-effect boxListCitationUpdate{{this._id}}"
                                      style="cursor: pointer;border-radius: 10px;">
                                      <ion-icon name="folder-open-outline"></ion-icon>
                                      <span class="ml-2">Thông tin hồ sơ</span>
                                    </div>
                                  </div>
                                </div>
                                {{!-- form Product --}}
                                <div class="form-row col-sm-12 col-md-12 col-xl-9 form_productUpdate{{this._id}}">
                                  {{!-- code --}}
                                  <div class="col-md-2 mb-3">
                                    <label for="Code">Mã</label>
                                    <input value="{{this.Code}}" name="Code" type="text" class="form-control"
                                      id="Code{{this._id}}" required>
                                  </div>
                                  {{!-- title --}}
                                  <div class="col-md-8 mb-3">
                                    <label for="Name">Tên sản phẩm</label>
                                    <input value="{{this.Name}}" name="Name" type="text" class="form-control"
                                      id="Name{{this._id}}" required>
                                  </div>
                                  {{!-- IsStatus --}}
                                  <div class="custom-control custom-switch col-md-2"
                                    style="display: flex; justify-content: center;align-items: center;">
                                    {{#ifCond IsActive 1}}
                                    <input name="IsActive" type="checkbox" class="custom-control-input"
                                      id="IsActive{{this._id}}" checked>
                                    <label class="custom-control-label block" for="IsActive{{this._id}}">Áp
                                      dụng</label>
                                    {{else}}
                                    <input name="IsActive" type="checkbox" class="custom-control-input"
                                      id="IsActive{{this._id}}">
                                    <label class="custom-control-label block" for="IsActive{{this._id}}">Áp
                                      dụng</label>
                                    {{/ifCond}}
                                  </div>
                                  {{!-- mô tả sản phẩm --}}
                                  <div class="col-md-12 mb-3 mt-3">
                                    <label for="Description">Mô tả sản phẩm</label>
                                    <textarea id="Description{{this._id}}" name="Description"
                                      class="form-control">{{this._id}}</textarea>
                                  </div>
                                  {{!-- Customer --}}
                                  <div class="col-md-6 mb-3 mt-3">
                                    <label for="Customer_id">Chủ thể</label>
                                    <select id="Customer_id{{this._id}}" name="Customer_id"
                                      class="form-control selectProductAdd">
                                      {{#each ../Customer}}
                                      <option value="{{this._id}}" {{#ifCond this._id
                                        ../this.Customer_id}}selected{{/ifCond}}>{{this.Name}}</option>
                                      {{/each}}
                                    </select>
                                  </div>
                                  {{!-- Product- group --}}
                                  <div class="col-md-6 mb-3 mt-3">
                                    <label for="note">Nhóm sản phẩm</label>
                                    <select id="ProductGroup_id{{this._id}}" name="ProductGroup_id"
                                      class="form-control selectProductAdd">
                                      {{#each ../ProductGroup}}
                                      <option value="{{this._id}}" {{#ifCond this.IsActive 0}}disabled{{/ifCond}}
                                        {{#ifCond this._id ../this.ProductGroup_id}}selected{{/ifCond}}>
                                        {{this.Name}}</option>
                                      {{/each}}
                                    </select>
                                  </div>
                                  {{!-- Year Review --}}
                                  <div class="col-md-3 mb-3 mt-3">
                                    <label for="ProductYearId">Năm đánh giá</label>
                                    <select id="ProductYearId{{this._id}}" name="ProductYearId"
                                      class="form-control selectProductAdd">
                                      {{#each ../Review}}
                                      <option value="{{this._id}}" {{#ifCond ../this.status 0}}disabled{{/ifCond}}
                                        {{#ifCond this._id ../this.ProductYearId}}selected{{/ifCond}}>
                                        {{this.yearName}}
                                      </option>
                                      {{/each}}
                                    </select>
                                  </div>
                                  {{!-- note --}}
                                  <div class="col-md-9 mb-3 mt-3">
                                    <label for="Note">Ghi
                                      chú</label>
                                    <input value="{{this.Note}}" name="Note" type="text" class="form-control"
                                      id="Note{{this._id}}">
                                  </div>
                                </div>
                                {{!-- bảng viễn dẫn --}}
                                <div class="col-sm-9 col-md-12 col-xl-9 list_citationUpdate{{this._id}} displayNone"
                                  style="overflow-y: auto;height: 100%;font-size: 12px;">
                                  <table border="1" class="table table-hover table-border table-striped">
                                    <thead>
                                      <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th style="max-width: 85px;padding:8px">Bắt buộc</th>
                                        <th>Tệp đính kèm</th>
                                      </tr>
                                    </thead>
                                    <tbody id="tbody{{this._id}}">
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            </form>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                              <button onclick="handleUpdate('{{this._id}}')" class="btn btn-warning">Cập nhật sản
                                phẩm</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    {{!-- modal --}}
                    {{!-- icon eye --}}
                    <span onclick="handleProductDetail('{{this._id}}')" class="d-inline-block ml-3" tabindex="0"
                      data-toggle="tooltip" title="Xem chi tiết">
                      <ion-icon name="eye-outline" data-toggle="modal"
                        data-target="#exampleModalDetail{{this._id}}"></ion-icon>
                    </span>
                    {{!-- icon duyet --}}
                    {{#ifCondAnd this.Status 0 ../User.RoleId 1}}
                    <span onclick="handleProductStatus('{{this._id}}')" class="d-inline-block ml-3" tabindex="0"
                      data-toggle="tooltip" title="Duyệt">
                      <ion-icon name="checkbox-outline"></ion-icon>
                    </span>
                    {{/ifCondAnd}}
                    {{!-- icon xoa --}}
                    <span class="d-inline-block ml-3" tabindex="0" data-toggle="tooltip" title="Xóa">
                      <ion-icon id="icon_moveToTrash" name="trash-outline" data-id="{{this._id}}">
                      </ion-icon>
                    </span>
                    {{!-- modal xem chi tiet --}}
                    <div class="modal fade" id="exampleModalDetail{{this._id}}" tabindex="-1" role="dialog"
                      aria-labelledby="exampleModalLabel" aria-hidden="true">
                      <div class="modal-dialog" role="document">
                        <div class="modal-content" style="width: 1100px;height: 98vh; overflow-y: auto;">
                          <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Xem chi tiết sản phẩm {{this.Name}}</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                              <span aria-hidden="true">&times;</span>
                            </button>
                          </div>
                          <div class="modal-body">
                            <form enctype="multipart/form-data">
                              <div class="row row-content">
                                {{!-- form Product --}}
                                <div class="form-row col-sm-12 form_product">
                                  {{!-- title --}}
                                  <div class="col-md-12 mb-3">
                                    <label for="Name">Tên sản phẩm</label>
                                    <input value="{{this.Name}}" name="Name" type="text" class="form-control" id="Name"
                                      style="pointer-events: none;">

                                  </div>
                                  <div class=" col-md-6 mb-3 mt-3">
                                    <label for="Customer_id">Chủ thể</label>
                                    <input type="text" class="form-control" value="{{this.customer_name}}"
                                      style="pointer-events: none;">
                                  </div>
                                  {{!-- Product- group --}}
                                  <div class="col-md-6 mb-3 mt-3">
                                    <label for="note">Nhóm sản phẩm</label>
                                    <input type="text" class="form-control" value="{{this.productGroup_name}}"
                                      style="pointer-events: none;">
                                  </div>
                                  {{!-- Year Review --}}
                                  <div class="col-md-6 mb-3 mt-3">
                                    <label for="ProductYearId">Năm đánh giá</label>
                                    <input type="text" class="form-control" value="{{this.yearName}}"
                                      style="pointer-events: none;">
                                  </div>
                                  {{!-- note --}}
                                  <div class="col-md-6 mb-3 mt-3">
                                    <label for="Note">Ghi
                                      chú</label>
                                    <input value="{{this.Note}}" name="Note" type="text" class="form-control" id="Note"
                                      style="pointer-events: none;">
                                  </div>
                                  {{!-- mô tả sản phẩm --}}
                                  <div class="col-md-12 mb-3 mt-3">
                                    <label for="Description">Mô tả sản phẩm</label>
                                    <textarea id="Description" name="Description" class="form-control"
                                      style="pointer-events: none;">{{this.Description}}</textarea>
                                  </div>
                                  {{!-- Customer --}}


                                </div>
                                {{!-- bảng viễn dẫn --}}
                                <div class="list_citation col-sm-12" style="font-size: 13px;">
                                  <table border="1" class="table table-hover table-border table-striped">
                                    <thead>
                                      <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Bắt buộc</th>
                                        <th>Tệp đính kèm</th>
                                      </tr>
                                    </thead>
                                    <tbody id="bodyProductDetail{{this._id}}">

                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>
                  </td>
                  {{!-- end icons --}}
                </tr>
                {{/each }}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div><!--End Row-->
  </div>
  <!--End content-wrapper-->
  {{> footer}}

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      buttonAddProduct.addEventListener("click", () => {
        $(".selectProductAdd").select2();
      })
    })
  </script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/assets/js/custom.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>
  {{!-- checkbox --}}
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'UA-56159088-1');
    // checkbox All
    $("#checkAll").click(function (e) {
      $(".check").prop('checked', $(this).prop('checked'));
    });
  </script>
  {{!-- actions --}}
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const toastData = localStorage.getItem('toast');
      if (toastData) {
        const toast = JSON.parse(toastData);
        $.toast(toast);
        localStorage.removeItem('toast');
      }
      const btnTrash = document.querySelectorAll("#icon_moveToTrash");
      //remove One
      for (let btn of btnTrash) {
        btn.addEventListener("click", (event) => {
          $.confirm({
            title: '<ion-icon name="trash-bin-outline"></ion-icon>',
            content: 'Bạn có chắc chắn muốn xóa ?',
            buttons: {
              confirm: {
                text: 'Confirm',
                btnClass: 'btn-red',
                action: function () {
                  // Lấy ID của mục cần xóa từ thuộc tính data-id của nút
                  const id = event.target.dataset.id;

                  // Gọi API xóa mục
                  fetch(`/product-manage/removeToTrash/${id}`, {
                    method: 'DELETE'
                  }).then(response => {
                    if (response.ok) {
                      localStorage.setItem('toast', JSON.stringify({
                        position: "top-right",
                        heading: 'Xóa thành công',
                        text: 'Đã xóa thành công thành công',
                        icon: 'success',
                        loader: true,
                        loaderBg: '#9EC600',
                        showHideTransition: 'slide',
                        stack: 4
                      }));
                      window.location.reload()
                    } else {
                      alert('Có lỗi xảy ra khi xóa mục');
                    }
                  }).catch(error => {
                    $.alert('Đã hủy');
                  });
                }
              },
              cancel: function () {
                $.alert('Đã hủy!');
              }
            }
          });
        })
      }
      const btnsCheck = document.querySelectorAll(".check")
      const btnDeleteAll = document.querySelector(".btnDeleteAll")
      const btnDisabled = document.querySelector(".btnDisabled")
      // khong checked thi se disabled nut
      let count = 0
      const checkBtnDisabled = () => {
        if (count === 0) {
          btnDisabled.setAttribute("disabled", true)
        } else {
          btnDisabled.removeAttribute("disabled")
        }
      }
      for (let checked of btnsCheck) {
        checkBtnDisabled()
        checked.addEventListener("click", (e) => {
          if (checked.checked) {
            count++
          } else {
            count--
          }
          checkBtnDisabled()
        })
      }
      //removeAll
      btnDeleteAll.addEventListener("click", async (e) => {
        $.confirm({
          title: '<ion-icon name="trash-bin-outline"></ion-icon>',
          content: 'Xác nhận xóa những đối tượng bạn đã chọn ?',
          buttons: {
            confirm: {
              text: 'Confirm',
              btnClass: 'btn-red',
              action: async function () {
                const arrId = []
                for (let btnCheck of btnsCheck) {
                  if (btnCheck.checked) {
                    const id = btnCheck.dataset.idcheckbox
                    arrId.push(id)
                  }
                }
                await fetch(`/product-manage/removeToTrashAll`, {
                  method: 'POST',
                  body: JSON.stringify(arrId),
                  headers: {
                    "Content-Type": "application/json"
                  }
                })
                localStorage.setItem('toast', JSON.stringify({
                  position: "top-right",
                  heading: 'Xóa thành công',
                  text: 'Đã xóa thành công thành công',
                  icon: 'success',
                  loader: true,
                  loaderBg: '#9EC600',
                  showHideTransition: 'slide',
                  stack: 4
                }));
                window.location.reload()
              }
            },
            cancel: function () {
              $.alert('Đã hủy');
            }
          }
        });
      })
    })
  </script>
  {{!-- upload anh --}}
  <script>
    function onclickImage(Id) {
      console.log(`avatarPreview` + Id)
      const img = document.getElementById('avatar' + Id)
      const imagePreview = document.getElementById(`avatarPreview${Id}`)
      console.log(imagePreview)
      img.click();
      // change ảnh khi chọ
      img.addEventListener('change', function () {
        if (img.files && img.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            imagePreview.src = e.target.result;
          };
          reader.readAsDataURL(img.files[0]);
        }
      });
    }
  </script>
  {{!-- Actions duyet san pham --}}
  <script>
    function handleProductStatus(productId) {
      const CreatorUser_id = document.getElementById("CreatorUser_id").value
      $.confirm({
        title: '<ion-icon name="checkmark-circle-outline"></ion-icon>',
        content: 'Duyệt sản phẩm ?',
        buttons: {
          confirm: {
            text: 'Duyệt',
            btnClass: 'btn-blue',
            action: async function () {

              const product = {
                Status: 1
              }
              // Lấy ID của mục cần duyệt từ thuộc tính data-id của nút
              const res = await fetch(`/product-manage/updateStatus/${productId}`, {
                method: 'PATCH',
                body: JSON.stringify(product),
                headers: {
                  "Content-Type": "application/json"
                }
              })
              //object productId de tao scoreFile
              const formScoreFile = {
                Product_id: Number(productId),
                CreatorUser_id: Number(CreatorUser_id),
              }
              const resScoreFile = await fetch(`/scoreFile/add`, {
                method: 'POST',
                body: JSON.stringify(formScoreFile),
                headers: {
                  "Content-Type": "application/json"
                }
              })
              localStorage.setItem('toast', JSON.stringify({
                position: "top-right",
                heading: 'SUCCESS!',
                text: 'Đã duyệt thành công thành công',
                icon: 'success',
                loader: true,
                loaderBg: '#9EC600',
                showHideTransition: 'slide',
                stack: 4
              }));
              window.location.reload()
            }
          },
          cancel: function () {
            $.alert('Đã hủy!');
          }
        }
      });
    }
  </script>
  {{!-- getOneProduct and productDetail --}}
  <script src="/assets/js/getOneProduct.js"></script>
  {{!-- show productDetail --}}
  <script src="/assets/js/showProductDetail.js"></script>
  {{!-- Gallery --}}
  <script src="/assets/js/addGallery.js"></script>
  {{!-- updateProduct --}}
  <script src="/assets/js/updateProduct.js"></script>