{{> header}}
<div class="content-wrapper">
    <div class="container-fluid">
        <div class="row" style="max-width: 100%; display: contents;">
            <ul class="search-customer"
                style="list-style: none; display:flex; justify-content: space-between; align-items: center;">
                <div class="">
                    <button class="btn btn-danger btnDeleteAll btnDisabledDelete">Xóa mục đã chọn</button>
                    <button class="btn btn-info btnRevertAll ml-3 btnDisabledRevert">Khôi phục mục đã
                        chọn</button>
                </div>
            </ul>
            </li>
            </ul>
        </div>
    </div>
    <!-- End container-fluid-->
    <div class="row" style="display: contents;">
        <div class="col-lg-6" style="max-width: 100%;">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items">
                        <span style="cursor: pointer;" class="d-inline-block mr-3" tabindex="0" data-toggle="tooltip"
                            title="Trở về">
                            <a href="/product-manage">
                                <ion-icon name="arrow-undo-outline"></ion-icon>
                            </a>
                        </span>
                        <h5 class="card-title">Khôi phục sản phẩm</h5>
                    </div>
                    <div class="table-responsive">
                        <table id="myTable" class="table table-hover">
                            <thead>
                                <tr>
                                    <th {{#ifCond Product.length 0}}hidden{{/ifCond}}>
                                        <div class="checkbox-wrapper-42 checkbox">
                                            <input id="checkAll" type="checkbox" class="check" />
                                            <label class="cbx" for="checkAll"></label>
                                        </div>
                                    </th>
                                    <th scope="col">Mã sản phẩm</th>
                                    <th scope="col">Tên sản phẩm</th>
                                    <th scope="col">Nhóm sản phẩm</th>
                                    <th scope="col">Năm đánh giá</th>
                                    <th scope="col">Chủ thể</th>
                                    <th scope="col">Ghi chú</th>
                                    <th scope="col">Hành động</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each Product}}
                                <tr>
                                    <td>
                                        <div class="checkbox-wrapper-42 checkbox">
                                            <input id="cbx-42{{this._id}}" type="checkbox" class="check"
                                                data-idCheckBox="{{this._id}}" />
                                            <label class="cbx" for="cbx-42{{this._id}}"></label>
                                        </div>
                                    </td>
                                    <td>{{this.Code}}</td>
                                    <td>{{this.Name}}</td>
                                    {{#ifCond productgroup_IsDeleted 0}}
                                    <td style="text-wrap: wrap;">{{this.productGroup_name}}</td>
                                    {{else}}
                                    <td class="text-hightlight">Không xác định</td>
                                    {{/ifCond}}
                                    {{#ifCond yearreview_IsDeleted 0}}
                                    <td>{{this.yearName}}</td>
                                    {{else}}
                                    <td class="text-hightlight">Không xác định</td>
                                    {{/ifCond}}
                                    {{#ifCond customer_IsDeleted 0}}
                                    <td>{{this.customer_name}}</td>
                                    {{else}}
                                    <td class="text-hightlight">Không xác định</td>
                                    {{/ifCond}}
                                    <td>{{this.Note}}</td>
                                    <td style="display: flex;">
                                        <div class="action_center">
                                            <button data-toggle="modal" data-target="#exampleModal{{this._id}}"
                                                style="background-color: transparent;border: none;cursor: pointer;">
                                                <span class="d-inline-block" tabindex="0" data-toggle="tooltip"
                                                    title="Khôi phục: {{this.product_name}}">
                                                    <ion-icon name="sync-outline" style="color: white; font-size: 18px;"
                                                        id="icon_revert" data-id="{{this._id}}"></ion-icon>
                                                </span>
                                            </button>
                                        </div>
                                        <div class="delete_action">
                                            <span class="d-inline-block" tabindex="0" data-toggle="tooltip"
                                                title="Xóa vĩnh viễn">
                                                <button class="delete-button"
                                                    style="background-color: transparent;border: none;">
                                                    <ion-icon id="icon_moveToTrash" name="trash-outline"
                                                        data-id="{{this._id}}">
                                                    </ion-icon>
                                                </button>
                                            </span>
                                        </div>
                                    </td>
                                </tr>
                                {{/each }}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div><!--End Row-->
    </div>

    <!--End content-wrapper-->
    {{> footer}}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/helpers/custom-product.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.7/handlebars.min.js"></script>

    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());
        gtag('config', 'UA-56159088-1');
        // checkbox All
        $("#checkAll").click(function (e) {
            $(".check").prop('checked', $(this).prop('checked'));
        });
    </script>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>


    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const toastData = localStorage.getItem('toast');
            if (toastData) {
                const toast = JSON.parse(toastData);
                $.toast(toast);
                localStorage.removeItem('toast');
            }
            const btnReverts = document.querySelectorAll("#icon_revert")
            const btnTrash = document.querySelectorAll("#icon_moveToTrash");
            //remove One
            for (let btn of btnTrash) {
                btn.addEventListener("click", (event) => {
                    $.confirm({
                        title: '<ion-icon name="trash-bin-outline"></ion-icon>',
                        content: 'Bạn có chắc chắn muốn xóa ?',
                        buttons: {
                            confirm: {
                                text: 'Confirm',
                                btnClass: 'btn-red',
                                action: function () {
                                    // Lấy ID của mục cần xóa từ thuộc tính data-id của nút
                                    const id = event.target.dataset.id;

                                    // Gọi API xóa mục
                                    fetch(`/product-manage/remove/${id}`, {
                                        method: 'DELETE'
                                    }).then(response => {
                                        if (response.ok) {
                                            localStorage.setItem('toast', JSON.stringify({
                                                position: "top-right",
                                                heading: 'Xóa thành công',
                                                text: 'Đã xóa thành công thành công',
                                                icon: 'success',
                                                loader: true,
                                                showHideTransition: 'slide',
                                                loaderBg: '#9EC600'
                                            }));
                                            window.location.reload()
                                        } else {
                                            alert('Có lỗi xảy ra khi xóa mục');
                                        }
                                    }).catch(error => {
                                        $.alert('Đã hủy');
                                    });
                                }
                            },
                            cancel: function () {
                                $.alert('Đã hủy!');
                            }
                        }
                    });
                })
            }
            //revertOne
            for (let btnRevert of btnReverts) {
                btnRevert.addEventListener("click", async (event) => {
                    $.confirm({
                        title: '<ion-icon name="help-circle-outline"></ion-icon>',
                        content: 'Bạn muốn khôi phục ?',
                        buttons: {
                            confirm: {
                                text: 'Confirm',
                                btnClass: 'btn-blue',
                                action: function () {
                                    // Lấy ID của mục cần xóa từ thuộc tính data-id của nút
                                    const id = event.target.dataset.id;

                                    // Gọi API xóa mục
                                    fetch(`/product-manage/revert/${id}`, {
                                        method: 'PATCH'
                                    }).then(response => {
                                        if (response.ok) {
                                            localStorage.setItem('toast', JSON.stringify({
                                                position: "top-right",
                                                heading: 'Khôi phục thành công',
                                                text: 'Đã khôi phục thành công thành công',
                                                icon: 'info',
                                                loader: true,
                                                loaderBg: '#9EC600',
                                                showHideTransition: 'slide'
                                            }));
                                            window.location.reload()
                                        } else {
                                            alert('Có lỗi xảy ra khi xóa mục');
                                        }
                                    }).catch(error => {
                                        $.alert('Đã hủy');
                                    });
                                }
                            },
                            cancel: function () {
                                $.alert('Đã hủy!');
                            }
                        }
                    });
                })
            }
            const btnsCheck = document.querySelectorAll(".check")
            const btnDeleteAll = document.querySelector(".btnDeleteAll")
            const btnDisabledDelete = document.querySelector(".btnDisabledDelete")
            const btnDisabledRevert = document.querySelector(".btnDisabledRevert")
            //Chưa checked thì disbale nút xóa all
            let count = 0
            const checkBtnDisabled = () => {
                if (count === 0) {
                    btnDisabledDelete.setAttribute("disabled", true)
                    btnDisabledRevert.setAttribute("disabled", true)
                } else {
                    btnDisabledDelete.removeAttribute("disabled")
                    btnDisabledRevert.removeAttribute("disabled")
                }
            }
            for (let checked of btnsCheck) {
                checkBtnDisabled()
                checked.addEventListener("click", (e) => {
                    if (checked.checked) {
                        count++
                    } else {
                        count--
                    }
                    checkBtnDisabled()
                })
            }
            //removeAll
            btnDeleteAll.addEventListener("click", async (e) => {
                $.confirm({
                    title: '<ion-icon name="trash-bin-outline"></ion-icon>',
                    content: 'Bạn muốn xóa mục đã chọn ?',
                    buttons: {
                        confirm: {
                            text: 'Confirm',
                            btnClass: 'btn-red',
                            action: async function () {
                                const arrId = []
                                for (let btnCheck of btnsCheck) {
                                    if (btnCheck.checked) {
                                        const id = btnCheck.dataset.idcheckbox
                                        arrId.push(id)
                                    }
                                }
                                const res = await fetch(`/product-manage/removeAll`, {
                                    method: "POST",
                                    body: JSON.stringify(arrId),
                                    headers: {
                                        "Content-Type": "application/json"
                                    }
                                })
                                localStorage.setItem('toast', JSON.stringify({
                                    position: "top-right",
                                    heading: 'Xóa thành công',
                                    text: 'Đã xóa thành công thành công',
                                    icon: 'success',
                                    loader: true,
                                    loaderBg: '#9EC600',
                                    showHideTransition: 'slide'
                                }));
                                window.location.reload()
                            }
                        },
                        cancel: function () {
                            $.alert('Đã hủy!');
                        }
                    },
                })
            })
            //RevertByCheckBox
            const btnRevertAll = document.querySelector(".btnRevertAll")
            btnRevertAll.addEventListener("click", async (e) => {
                $.confirm({
                    title: '<ion-icon name="help-circle-outline"></ion-icon>',
                    content: 'Bạn muốn khôi phục mục đã chọn ?',
                    buttons: {
                        confirm: {
                            text: 'Confirm',
                            btnClass: 'btn-blue',
                            action: async function () {
                                const arrId = []
                                for (let btnCheck of btnsCheck) {
                                    if (btnCheck.checked) {
                                        const id = btnCheck.dataset.idcheckbox
                                        arrId.push(id)

                                    }
                                }
                                const res = await fetch(`/product-manage/revertAll`, {
                                    method: "POST",
                                    body: JSON.stringify(arrId),
                                    headers: {
                                        "Content-Type": "application/json"
                                    }
                                })
                                localStorage.setItem('toast', JSON.stringify({
                                    position: "top-right",
                                    heading: 'Khôi phục thành công',
                                    text: 'Đã khôi phục thành công thành công',
                                    icon: 'info',
                                    loader: true,
                                    loaderBg: '#9EC600',
                                    showHideTransition: 'slide'
                                }));
                                window.location.reload()
                            }
                        },
                        cancel: function () {
                            $.alert('Đã hủy!');
                        }
                    }
                });
            })
        })
    </script>