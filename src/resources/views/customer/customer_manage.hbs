{{> header}}
<style>
  .bootstrap-select:not(.input-group-btn) {
    display: block;
  }
</style>
<div class="content-wrapper">
  <div class="container-fluid">
    <div class="row" style="max-width: 100%; display: contents;">
      <ul class="search-customer"
        style="list-style: none; display:flex; justify-content: space-between; align-items: center;">
        <button class="btn btn-danger btnDeleteAll btnDisabled" style="float: left;">Xóa mục đã chọn</button>
        <div class="import_customer_button"
          style="list-style: none; display:flex; justify-content: space-between; align-items: center;">
          <button class="btn btn-info" data-toggle="modal" data-target="#modalCustomerAdd">Thêm mới</button>
        </div>
        {{> modalCustomer}}
      </ul>
    </div>
    <!-- End container-fluid-->
  </div>
  <div class="row" style="display: contents;">
    <div class="col-lg-6" style="max-width: 100%;">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items">
            <h5 class="card-title">Danh sách chủ thể</h5>
            <span class="d-inline-block ml-3" tabindex="0" data-toggle="tooltip" title="Thùng rác của bạn">
              <a href="/customer-manage/trash">
                <ion-icon name="trash-outline">
                </ion-icon>
              </a>
            </span>
          </div>
          <div class="row justify-content-end mb-4">
            {{!-- <div class=" col-2" style="cursor: pointer">
              <label for="">Lọc theo: Quận / Huyện</label>
              <select name="" id="" class="form-control selectpicker" data-live-search="true">
                <option value="" style="">Tất cả</option>
                {{#each District}}
                <option value="{{this._id}}">{{this.Name}}
                </option>
                {{/each}}
              </select>
            </div> --}}
            <div class="col-3">
              <form action="GET" method="/customer-manage"></form>
              <div class="input-group ">
                <input type="text" style="font-size: 18px;" class="form-control" placeholder="Tìm kiếm chủ thể..."
                  aria-label="Recipient's username" aria-describedby="basic-addon2" name="searchName">
                <div class="input-group-append">
                  <button class="btn btn-click" type="button"><ion-icon name="search-outline"
                      style="font-size: 18px;"></ion-icon></button>
                </div>
              </div>
            </div>
          </div>

          <div class="table-responsive">
            <table id="myTableCustomer" class="table datatables table-bordered table-hover table-striped">
              <thead>
                <tr>
                  <th {{#ifCond Customer.length 0}}hidden{{/ifCond}}>
                    <div class="checkbox-wrapper-42 checkbox">
                      <input id="checkAll" type="checkbox" class="check" />
                      <label class="cbx" for="checkAll"></label>
                    </div>
                  </th>
                  <th hidden>DistrictId</th>
                  <th scope="col">Chủ thể</th>
                  <th scope="col">Điện thoại</th>
                  <th scope="col">Địa chỉ</th>
                  <th scope="col">Hành động</th>
                </tr>
              </thead>
              <tbody>
                {{#each Customer}}
                <tr>
                  <td>
                    <div class="checkbox-wrapper-42 checkbox">
                      <input id="cbx-42{{this._id}}" type="checkbox" class="check" data-idCheckBox="{{this._id}}" />
                      <label class="cbx" for="cbx-42{{this._id}}"></label>
                    </div>
                  </td>
                  <td hidden>
                    {{this.District_id}}
                  </td>
                  <td style="max-width: 200px">
                    <div class="" style="display: flex;flex-direction: column">
                      <p style="text-wrap: wrap;font-size: 12px;text-transform: uppercase;" class="text-black-custom">
                        {{this.Name}}</p>
                      <p style="text-wrap: wrap;font-size: 12px;text-transform: uppercase;font-weight: 700;"
                        class="text-hightlight">
                        {{this.SubName}}</p>
                    </div>
                  </td>
                  <td style="max-width: 150px;">
                    <p>{{this.Phone}}</p>
                  </td>
                  <td style="max-width: 150px;">
                    <p class="text-overhidden" style="word-break: break-word;">Tỉnh {{this.city_name}} ,
                      {{this.district_name}} , {{this.ward_name}}
                    </p>
                  </td>
                  <td>
                    <span class="d-inline-block ml-3" tabindex="0" data-toggle="tooltip" title="Chỉnh sửa">
                      <ion-icon name="create-outline" data-toggle="modal"
                        data-target="#exampleModal{{this._id}}"></ion-icon>
                    </span>

                    <span class="d-inline-block ml-2" tabindex="0" data-toggle="tooltip" title="Xóa">
                      <ion-icon id="icon_moveToTrash" name="trash-outline" data-id="{{this._id}}">
                      </ion-icon>
                    </span>
                  </td>
                </tr>
                {{> modalCustomer District=../District Province=../Province Ward=../Ward}}
                {{!-- end modal --}}
                {{else}}
                {{/each }}
              </tbody>
            </table>
          </div>

          <div class="col-lg-12 ">
            <div class=" ">
              <nav aria-label="Page navigation ">
                <ul class="pagination center">
                  {{#if pagination.prev}}
                  <li class="page-item">
                    <a class="page-link" href="/customer-manage?page={{pagination.prev}}" aria-label="Previous">
                      <span aria-hidden="true">&laquo;</span>
                    </a>
                  </li>
                  {{/if}}

                  {{#each pagination.pages}}
                  <li class="page-item {{#if this.active}}active{{/if}}">
                    <a class="page-link" href="/customer-manage?page={{this.number}}">{{this.number}}</a>
                  </li>
                  {{/each}}

                  {{#if pagination.next}}
                  <li class="page-item">
                    <a class="page-link" href="/customer-manage?page={{pagination.next}}" aria-label="Next">
                      <span aria-hidden="true">&raquo;</span>
                    </a>
                  </li>
                  {{/if}}
                </ul>
              </nav>
            </div>

          </div>
        </div>
      </div>
    </div><!--End Row-->
  </div>

  {{> footer}}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script src="/assets/js/custom.js"></script>
  <script src="/assets/js/customer/Address.js"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'UA-56159088-1');
    // checkbox All
    $("#checkAll").click(function (e) {
      $(".check").prop('checked', $(this).prop('checked'));
    });
  </script>
  <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>
  {{!-- action delete --}}
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const toastData = localStorage.getItem('toast');
      if (toastData) {
        const toast = JSON.parse(toastData);
        $.toast(toast);
        localStorage.removeItem('toast');
      }
      const btnTrash = document.querySelectorAll("#icon_moveToTrash");
      //remove One
      for (let btn of btnTrash) {
        btn.addEventListener("click", (event) => {
          $.confirm({
            title: '<ion-icon name="trash-bin-outline"></ion-icon>',
            content: 'Bạn có chắc chắn muốn xóa ?',
            buttons: {
              confirm: {
                text: 'Confirm',
                btnClass: 'btn-red',
                action: function () {
                  // Lấy ID của mục cần xóa từ thuộc tính data-id của nút
                  const id = event.target.dataset.id;

                  // Gọi API xóa mục
                  fetch(`/customer-manage/${id}`, {
                    method: 'DELETE'
                  }).then(response => {
                    if (response.ok) {
                      localStorage.setItem('toast', JSON.stringify({
                        position: "top-right",
                        heading: 'Xóa thành công',
                        text: 'Đã xóa thành công thành công',
                        icon: 'success',
                        loader: true,
                        showHideTransition: 'slide',
                        loaderBg: '#9EC600',
                        stack: 4
                      }));
                      window.location.reload()
                    } else {
                      alert('Có lỗi xảy ra khi xóa mục');
                    }
                  }).catch(error => {
                    $.alert('Đã hủy');
                  });
                }
              },
              cancel: function () {
                $.alert('Đã hủy!');
              }
            }
          });
        })
      }
      const btnsCheck = document.querySelectorAll(".check")
      const btnDeleteAll = document.querySelector(".btnDeleteAll")
      const btnDisabled = document.querySelector(".btnDisabled")
      //Chưa checked thì disbale nút xóa all
      let count = 0
      const checkBtnDisabled = () => {
        if (count === 0) {
          btnDisabled.setAttribute("disabled", true)
        } else {
          btnDisabled.removeAttribute("disabled")
        }
      }
      for (let checked of btnsCheck) {
        checkBtnDisabled()
        checked.addEventListener("click", (e) => {
          if (checked.checked) {
            count++
          } else {
            count--
          }
          checkBtnDisabled()
        })
      }
      //removeAll
      btnDeleteAll.addEventListener("click", async (e) => {
        $.confirm({
          title: '<ion-icon name="trash-bin-outline"></ion-icon>',
          content: 'Xác nhận xóa những đối tượng bạn đã chọn ?',
          buttons: {
            confirm: {
              text: 'Confirm',
              btnClass: 'btn-red',
              action: async function () {
                const arrId = []
                for (let btnCheck of btnsCheck) {
                  if (btnCheck.checked) {
                    const id = btnCheck.dataset.idcheckbox
                    arrId.push(id)
                  }
                }
                console.log(arrId)
                await fetch(`/customer-manage/removeAll`, {
                  method: 'POST',
                  body: JSON.stringify(arrId),
                  headers: {
                    "Content-Type": "application/json"
                  }
                })
                localStorage.setItem('toast', JSON.stringify({
                  position: "top-right",
                  heading: 'Xóa thành công',
                  text: 'Đã xóa thành công thành công',
                  icon: 'success',
                  loader: true,
                  showHideTransition: 'slide',
                  loaderBg: '#9EC600',
                  stack: 4
                }));
                window.location.reload()
              }
            },
            cancel: function () {
              $.alert('Đã hủy');
            }
          }
        });
      })
    })
  </script>