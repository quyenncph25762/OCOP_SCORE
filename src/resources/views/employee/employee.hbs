<style>
    .modal-employee {
        width: 950px;
    }

    @media screen and (max-width: 765px) {
        .modal-employee {
            width: 100%;
        }

        .file-upload {
            margin-bottom: 40px;
        }
    }
</style>
{{> header}}
<div class="content-wrapper">
    <div class="container-fluid">
        <div class="row" style="max-width: 100%; display: contents;">
            <ul class="search-customer"
                style="list-style: none; display:flex; justify-content: space-between; align-items: center;">
                <button class="btn btn-danger btnDeleteAll btnDisabled" style="float: left;">Xóa mục đã chọn</button>
                <div class="import_customer_button"
                    style="list-style: none; display:flex; justify-content: space-between; align-items: center;">
                    <button class="btn btn-success" data-toggle="modal" data-target="#exampleModal">Thêm mới</button>
                </div>
                {{> modalEmployee}}
            </ul>
            </li>
            </ul>
        </div>
    </div>
    {{!-- body --}}
    <div class="row" style="display: contents;">
        <div class="col-lg-6" style="max-width: 100%;">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items">
                        <h5 class="card-title">Danh sách cán bộ</h5>
                        <span class="d-inline-block ml-3" tabindex="0" data-toggle="tooltip" title="Thùng rác của bạn">
                            <a href="/employee/trash">
                                <i class="icon-trash" style="font-size: 20px; color:red; cursor: pointer;"></i>
                            </a>
                        </span>
                    </div>
                    <div class="table-responsive">
                        <table id="myTable" class="table table-hover">
                            <thead>
                                <tr>
                                    <th {{#ifCond Employee.length 0}}hidden{{/ifCond}}>
                                        <div class="checkbox">
                                            <input type="checkbox" class="check" id="checkAll">
                                        </div>
                                    </th>
                                    <th>Mã tài khoản</th>
                                    <th>Họ và tên</th>
                                    <th>Giới tính</th>
                                    <th>Vị trí chức danh</th>
                                    <th>Tổ / phòng ban</th>
                                    <th>Vai trò</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each Employee}}
                                <tr>
                                    <td>
                                        <div class="">
                                            <div class="checkbox">
                                                <input type="checkbox" class="check" data-idCheckBox="{{this._id}}">
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{this.Code}}</td>
                                    <td>{{this.FullName}}</td>
                                    <td>{{this.Gender}}</td>
                                    {{#ifCond workdepartment_IsDeleted 0}}
                                    <td>
                                        <p class="text-overhidden">{{this.workdepartment_name}}</p>
                                    </td>
                                    {{else}}
                                    <td style="color: rgb(236, 236, 118);">Không xác định</td>
                                    {{/ifCond}}
                                    {{#ifCond workposition_IsDeleted 0}}
                                    <td>{{this.workposition_name}}</td>
                                    {{else}}
                                    <td style="color: rgb(236, 236, 118);">Không xác định</td>
                                    {{/ifCond}}
                                    <td>{{this.role_name}}</td>
                                    <td scope="row" style="display: flex;">
                                        <div class="action_center">
                                            <button
                                                style="background-color: transparent;border: none ;cursor: pointer;">
                                                <span class="d-inline-block" tabindex="0" data-toggle="tooltip"
                                                    title="Chỉnh sửa">
                                                    <ion-icon name="create-outline" data-toggle="modal"
                                                        data-target="#exampleModal{{this._id}}"></ion-icon>
                                                </span>
                                            </button>
                                            {{!-- modal --}}
                                            <div class="modal fade" id="exampleModal{{this._id}}" tabindex="-1"
                                                role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                                <div class="modal-dialog modal__size" role="document">
                                                    <div class="modal-content modal-employee">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="exampleModalLabel">Sửa cán bộ
                                                            </h5>
                                                            <button type="button" class="close" data-dismiss="modal"
                                                                aria-label="Close">
                                                                <span aria-hidden="true">&times;</span>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body" style="overflow-y: auto;height: 100vh;">
                                                            <form method="POST" action="/employee/update/{{this._id}}"
                                                                enctype="multipart/form-data" class="row">
                                                                <div class="col-md-4">
                                                                    <h1
                                                                        style="font-size: 16px; text-align: center;font-weight: 600;">
                                                                        Ảnh đại diện</h1>
                                                                    <div class="file-upload" style="cursor: pointer;">
                                                                        <div>
                                                                            {{!-- avatar --}}
                                                                            <input type='file' name="Avatar"
                                                                                id="avatar{{this._id}}"
                                                                                style="display: none;">
                                                                            <input type="text" value="{{this.Avatar}}"
                                                                                name="Avatar" hidden>
                                                                            <div class="drag-text"
                                                                                onclick="onclickImage(`{{this._id}}`)">
                                                                                <img style="width: 100%; height: 100%;object-fit: cover;"
                                                                                    id="avatarPreview{{this._id}}"
                                                                                    class="file-upload-image"
                                                                                    src="{{this.Avatar}}" />
                                                                            </div>
                                                                        </div>
                                                                        {{!-- gender --}}
                                                                        <div class="d-flex justify-content-center mt-3">
                                                                            <div class="">
                                                                                <input type="radio" name="Gender"
                                                                                    id="nam{{this._id}}" value="nam"
                                                                                    {{#ifCond (toLowerCase
                                                                                    this.Gender) "nam"
                                                                                    }}checked{{/ifCond}}>
                                                                                <label for="nam">Nam</label>
                                                                            </div>
                                                                            <div class="ml-3">
                                                                                <input type="radio" name="Gender"
                                                                                    id="nu{{this._id}}" value="nu"
                                                                                    {{#ifCond (toLowerCase
                                                                                    this.Gender) "nu"
                                                                                    }}checked{{/ifCond}}>
                                                                                <label for="nu">Nữ</label>
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                </div>
                                                                <div class="col-md-8">
                                                                    <div class="form-row">
                                                                        {{!-- code --}}
                                                                        <div class="col-md-6 mb-3">
                                                                            <label for="code">Mã</label>
                                                                            <input value="{{this.Code}}" name="Code"
                                                                                type="text" class="form-control"
                                                                                id="code{{this._id}}" required>
                                                                        </div>
                                                                        {{!-- Email --}}
                                                                        <div class="col-md-6 mb-3">
                                                                            <label for="Email">E-mail</label>
                                                                            <input value="{{this.Email}}" name="Email"
                                                                                type="text" class="form-control"
                                                                                id="Email{{this._id}}" required>
                                                                        </div>
                                                                        {{!-- fullName --}}
                                                                        <div class="col-md-12 mb-3 mt-3">
                                                                            <label for="FullName">Họ và tên</label>
                                                                            <input value="{{this.FullName}}"
                                                                                name="FullName" type="text"
                                                                                class="form-control"
                                                                                id="FullName{{this._id}}" required>
                                                                            <span
                                                                                style="color: #de2935;font-size: 14px;font-style: italic;margin-top: 5px;font-weight: 600;"
                                                                                id="messageErrorUpdate{{this._id}}"></span>
                                                                        </div>
                                                                        {{!-- birthDay --}}
                                                                        <div class="col-md-6 mb-3 mt-3">
                                                                            <label for="DoB">Ngày sinh</label>
                                                                            <input value="{{this.formattedDoB}}"
                                                                                name="DoB" type="date"
                                                                                class="form-control"
                                                                                id="DoB{{this._id}}" required>
                                                                        </div>

                                                                        {{!-- tel --}}
                                                                        <div class="col-md-6 mb-3 mt-3">
                                                                            <label for="Phone">Số điện thoại</label>
                                                                            <input value="{{this.Phone}}" name="Phone"
                                                                                type="data" class="form-control"
                                                                                id="Phone{{this._id}}">
                                                                        </div>
                                                                        {{!-- address --}}
                                                                        <div class="col-md-12 mb-3 mt-3">
                                                                            <label for="Address">Địa chỉ</label>
                                                                            <input value="{{this.Address}}"
                                                                                name="Address" type="data"
                                                                                class="form-control"
                                                                                id="Address{{this._id}}">
                                                                        </div>
                                                                        {{!-- Customer --}}
                                                                        <div class="col-md-6 mb-3 mt-3">
                                                                            <label for="WorkDepartment_id">Tổ / Phòng
                                                                                ban</label>
                                                                            <select id="WorkDepartment_id{{this._id}}"
                                                                                name="WorkDepartment_id"
                                                                                class="form-control" required>
                                                                                {{#each ../WorkDepartMent}}
                                                                                <option value="{{this._id}}" {{#ifCond
                                                                                    this._id
                                                                                    ../this.WorkDepartment_id}}selected{{/ifCond}}>
                                                                                    {{this.title}}</option>
                                                                                {{/each}}
                                                                            </select>
                                                                        </div>
                                                                        {{!-- workPostitionId--}}
                                                                        <div class="col-md-6 mb-3 mt-3">
                                                                            <label for="WorkPosition_id">Vị trí chức
                                                                                danh</label>
                                                                            <select id="WorkPosition_id{{this._id}}"
                                                                                name="WorkPosition_id"
                                                                                class="form-control">
                                                                                {{#each ../WorkPosition}}

                                                                                <option value="{{this._id}}" {{#ifCond
                                                                                    this.IsActive 0}}disabled{{/ifCond}}
                                                                                    {{#ifCond this._id
                                                                                    ../this.WorkPosition_id}}selected{{/ifCond}}>
                                                                                    {{this.Name}}</option>

                                                                                {{/each}}
                                                                            </select>
                                                                        </div>
                                                                        {{!-- role --}}
                                                                        <div class="col-md-12 mb-3 mt-3">
                                                                            <label for="roleId">Vai trò</label>
                                                                            <select id="roleId{{this._id}}"
                                                                                name="roleId" class="form-control">
                                                                                {{#each ../Role}}
                                                                                <option value="{{this._id}}" {{#ifCond
                                                                                    this.status 0}}disabled{{/ifCond}}
                                                                                    {{#ifCond this._id
                                                                                    ../this.RoleId}}selected{{/ifCond}}>
                                                                                    {{this.title}}</option>

                                                                                {{/each}}
                                                                            </select>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </form>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-danger"
                                                                    data-dismiss="modal">Close</button>
                                                                <button type="button"
                                                                    onclick="handleUpdate('{{this._id}}')"
                                                                    class="btn btn-warning">Sửa cán
                                                                    bộ</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {{!-- end-modal --}}
                                        </div>
                                        <div class="delete_action">
                                            <span class="d-inline-block" tabindex="0" data-toggle="tooltip" title="Xóa">
                                                <ion-icon id="icon_moveToTrash" name="trash-outline"
                                                    data-id="{{this._id}}">
                                                </ion-icon>
                                            </span>
                                        </div>
                                    </td>
                                </tr>
                                {{else}}
                                <tr>
                                    <td colspan="9" class="text-center">Không tìm thấy từ khoá nào</td>
                                </tr>
                                {{/each }}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div><!--End Row-->
    </div>
    <!-- End container-fluid-->
</div><!--End content-wrapper-->
{{> footer}}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/assets/js/custom.js"></script>
<script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.7/handlebars.min.js"></script>
<script class="jsbin" src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
{{!-- upload anh --}}
<script>
    function onclickImage(Id) {
        console.log(`avatarPreview` + Id)
        const img = document.getElementById('avatar' + Id)
        const imagePreview = document.getElementById(`avatarPreview${Id}`)
        console.log(imagePreview)
        img.click();
        // change ảnh khi chọ
        img.addEventListener('change', function () {
            if (img.files && img.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    imagePreview.src = e.target.result;
                };
                reader.readAsDataURL(img.files[0]);
            }
        });
    }

</script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'UA-56159088-1');
    // checkbox All
    $("#checkAll").click(function (e) {
        $(".check").prop('checked', $(this).prop('checked'));
    });
</script>
{{!-- actions remove --}}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const toastData = localStorage.getItem('toast');
        if (toastData) {
            const toast = JSON.parse(toastData);
            $.toast(toast);
            localStorage.removeItem('toast');
        }
        const btnTrash = document.querySelectorAll("#icon_moveToTrash");
        //remove One
        for (let btn of btnTrash) {
            btn.addEventListener("click", (event) => {
                $.confirm({
                    title: '<ion-icon name="trash-bin-outline"></ion-icon>',
                    content: 'Bạn có chắc chắn muốn xóa ?',
                    buttons: {
                        confirm: {
                            text: 'Confirm',
                            btnClass: 'btn-red',
                            action: function () {
                                // Lấy ID của mục cần xóa từ thuộc tính data-id của nút
                                const id = event.target.dataset.id;

                                // Gọi API xóa mục
                                fetch(`/employee/removeToTrash/${id}`, {
                                    method: 'DELETE'
                                }).then(response => {
                                    if (response.ok) {
                                        localStorage.setItem('toast', JSON.stringify({
                                            position: "top-right",
                                            heading: 'Xóa thành công',
                                            text: 'Đã xóa thành công thành công',
                                            icon: 'success',
                                            loader: true,
                                            loaderBg: '#9EC600',
                                            showHideTransition: 'slide',
                                            stack: 4
                                        }));
                                        window.location.reload()
                                    } else {
                                        alert('Có lỗi xảy ra khi xóa mục');
                                    }
                                }).catch(error => {
                                    $.alert('Đã hủy');
                                });
                            }
                        },
                        cancel: function () {
                            $.alert('Đã hủy!');
                        }
                    }
                });
            })
        }
        const btnsCheck = document.querySelectorAll(".check")
        const btnDeleteAll = document.querySelector(".btnDeleteAll")
        const btnDisabled = document.querySelector(".btnDisabled")
        //Chưa checked thì disbale nút xóa all
        let count = 0
        const checkBtnDisabled = () => {
            if (count === 0) {
                btnDisabled.setAttribute("disabled", true)
            } else {
                btnDisabled.removeAttribute("disabled")
            }
        }
        for (let checked of btnsCheck) {
            checkBtnDisabled()
            checked.addEventListener("click", (e) => {
                if (checked.checked) {
                    count++
                } else {
                    count--
                }
                checkBtnDisabled()
            })
        }
        //removeAll
        btnDeleteAll.addEventListener("click", async (e) => {
            $.confirm({
                title: '<ion-icon name="trash-bin-outline"></ion-icon>',
                content: 'Xác nhận xóa những đối tượng bạn đã chọn ?',
                buttons: {
                    confirm: {
                        text: 'Confirm',
                        btnClass: 'btn-red',
                        action: function () {
                            for (let btnCheck of btnsCheck) {
                                if (btnCheck.checked) {
                                    const id = btnCheck.dataset.idcheckbox
                                    fetch(`/employee/removeToTrash/${id}`, {
                                        method: 'DELETE'
                                    })
                                }
                            }
                            localStorage.setItem('toast', JSON.stringify({
                                position: "top-right",
                                heading: 'Xóa thành công',
                                text: 'Đã xóa thành công thành công',
                                icon: 'success',
                                loader: true,
                                loaderBg: '#9EC600',
                                showHideTransition: 'slide',
                                stack: 4
                            }));
                            window.location.reload()
                        }
                    },
                    cancel: function () {
                        $.alert('Đã hủy');
                    }
                }
            });
        })
    })
</script>

{{!-- handleUpdate Employee --}}
<script>
    async function handleUpdate(id) {
        const Avatar = document.getElementById(`avatar${id}`)
        const imagePreview = document.getElementById(`avatarPreview${id}`);
        const nu = document.getElementById(`nu${id}`).check
        const nam = document.getElementById(`nam${id}`).check
        const Code = document.getElementById(`code${id}`).value
        const Email = document.getElementById(`Email${id}`).value
        const FullName = document.getElementById(`FullName${id}`).value
        const DoB = document.getElementById(`DoB${id}`).value
        const Phone = document.getElementById(`Phone${id}`).value
        const Address = document.getElementById(`Address${id}`).value
        const WorkDepartment_id = document.getElementById(`WorkDepartment_id${id}`).value
        const WorkPosition_id = document.getElementById(`WorkPosition_id${id}`).value
        const roleId = document.getElementById(`roleId${id}`).value
        //cat url
        const fileUrl = Avatar.files && Avatar.files[0] ? URL.createObjectURL(Avatar.files[0]) : imagePreview.src;
        const index = fileUrl.indexOf("Uploads/");
        let relativePath = "";
        if (index !== -1) {
            relativePath = fileUrl.substring(index);
        }
        const formData = new FormData()
        if (Avatar?.files[0]) {
            formData.append("Avatar", Avatar.files[0])
        } else {
            formData.append("Avatar", relativePath)
        }
        formData.append("Gender", nu ? "nu" : "nam")
        formData.append("Code", Code)
        formData.append("Email", Email)
        formData.append("DoB", DoB)
        formData.append("FullName", FullName)
        formData.append("Phone", Phone)
        formData.append("Address", Address)
        formData.append("WorkDepartment_id", WorkDepartment_id)
        formData.append("WorkPosition_id", WorkPosition_id)
        formData.append("roleId", roleId)
        const res = await fetch(`/employee/update/${id}`, {
            method: "POST",
            body: formData
        })
        if (res.ok) {
            const data = await res.json()
            localStorage.setItem('toast', JSON.stringify({
                position: "top-right",
                heading: 'Cập nhật thành công',
                text: 'Đã cập nhật thành công',
                icon: 'success',
                loader: true,
                loaderBg: '#9EC600',
                showHideTransition: 'slide',
                stack: 4
            }));
            window.location.replace("/employee")
        } else {
            const data = await res.json()
            const messageErrorUpdate = document.getElementById(`messageErrorUpdate${id}`)
            messageErrorUpdate.innerHTML = data.message
            console.error("Response was not ok:", res.status);
        }
    }
</script>