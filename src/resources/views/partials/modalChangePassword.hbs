<style>
    .modal-content {
        min-width: 800px;
    }

    @media screen and (min-width: 350px) and (max-width: 765px) {
        .modal-content {
            min-width: 100% !important;
        }
    }
</style>
<!-- Modal -->
<div class="modal fade" id="exampleModalChangePassword" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Đổi mật khẩu</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-row">
                        <div class="col-sm-12">
                            <label for="Code">Mật khẩu hiện tại</label>
                            <input type="password" class="form-control" id="Password" required>
                            <p style="font-size: 12px;color: #ccc;margin-top: 4px;">Bạn <a
                                    style="font-style: italic;text-decoration: solid;color: #6593E8;font-weight: 600;"
                                    class="" href="/auth/password/reset">quên mật
                                    khẩu?</a></p>
                        </div>
                        <div class="col-sm-6">
                            <label for="Code">Mật khẩu mới</label>
                            <input min="6" type="password" class="form-control" id="confirmPassword" required>
                        </div>
                        <div class="col-sm-6">
                            <label for="Code">Xác nhận mật khẩu mới</label>
                            <input min="6" type="password" class="form-control" id="reConfirmPassword" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-info" onclick="handleChangePassword('{{User._id}}')">
                    <div class="" style="display: flex;align-items: center;gap: 10px;">
                        <ion-icon name="save-outline"></ion-icon>
                        <p class="m-0">Lưu thông tin</p>
                    </div>
                </button>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<script>
    async function handleChangePassword(id) {
        const Password = document.getElementById("Password").value
        const confirmPassword = document.getElementById("confirmPassword").value
        const reConfirmPassword = document.getElementById("reConfirmPassword").value
        const req = {
            Password: CryptoJS.SHA256(Password).toString()
        }
        const res = await fetch(`/auth/findUserById/${id}`, {
            method: "POST",
            body: JSON.stringify(req),
            headers: {
                "Content-Type": "application/json"
            }
        })
        if (!res.ok) {
            $.toast({
                position: "top-right",
                heading: 'ERROR',
                text: 'Đã gặp sự cố server',
                icon: 'error',
                loader: true,
                loaderBg: '#9EC600',
                showHideTransition: 'slide',
                stack: 4
            })
        }
        const responseJson = await res.json()
        if (responseJson.length === 0) {
            $.toast({
                position: "top-right",
                heading: 'ERROR',
                text: 'Mật khẩu cũ không chính xác',
                icon: 'error',
                loader: true,
                loaderBg: '#9EC600',
                showHideTransition: 'slide',
                stack: 4
            })
        } else {
            //validate
            if (confirmPassword.trim() === "" || reConfirmPassword.trim() === "") {
                $.toast({
                    position: "top-right",
                    heading: 'WARNING',
                    text: 'Mật khẩu mới và mật khẩu xác nhận không được trống',
                    icon: 'warning',
                    loader: true,
                    loaderBg: '#9EC600',
                    showHideTransition: 'slide'
                })
                return
            }
            if (confirmPassword.trim().length < 6 || reConfirmPassword.trim().length < 6) {
                $.toast({
                    position: "top-right",
                    heading: 'WARNING',
                    text: 'Mật khẩu mới và mật khẩu xác nhận phải có độ dài từ 6 kí tự',
                    icon: 'warning',
                    loader: true,
                    loaderBg: '#9EC600',
                    showHideTransition: 'slide'
                })
                return
            }
            if (confirmPassword === reConfirmPassword) {
                //actions
                const newPassword = {
                    Password: CryptoJS.SHA256(confirmPassword).toString()
                }
                const res = await fetch(`/auth/changePassword/${id}`, {
                    method: "PATCH",
                    body: JSON.stringify(newPassword),
                    headers: {
                        "Content-Type": "application/json"
                    }
                })
                if (!res.ok) {
                    $.toast({
                        position: "top-right",
                        heading: 'ERROR',
                        text: 'Có lỗi xảy ra khi thay đổi mật khẩu vui lòng thử lại!',
                        icon: 'error',
                        loader: true,
                        loaderBg: '#9EC600',
                        showHideTransition: 'slide',
                        stack: 4
                    })
                    return
                }
                localStorage.setItem('toast', JSON.stringify({
                    position: "top-right",
                    heading: 'SUCCESS',
                    text: 'Cập nhật mật khẩu thành công',
                    icon: 'success',
                    loader: true,
                    loaderBg: '#9EC600',
                    showHideTransition: 'slide',
                    stack: 4
                }));
                localStorage.removeItem("User")
                clearCookie("User")
                window.location.replace("/auth/loginPage")
            } else {
                $.toast({
                    position: "top-right",
                    heading: 'ERROR',
                    text: 'Mật khẩu xác nhận không chính xác',
                    icon: 'error',
                    loader: true,
                    loaderBg: '#9EC600',
                    showHideTransition: 'slide',
                    stack: 4
                })
            }
        }
    }
</script>