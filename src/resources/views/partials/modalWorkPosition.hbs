{{!-- UPDATE --}}
{{#if this._id}}
<div class="modal fade" id="exampleModal{{this._id}}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal__size" role="document">
        <div class="modal-content model__content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Cập nhật vị trị , chức danh</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" class="width: 100%">
                <form>
                    <div class="form-row">
                        {{!-- code --}}
                        <div class="col-md-4 mb-3">
                            <label for="Code">Mã</label>
                            <input value="{{this.Code}}" name="Code" type="text" class="form-control"
                                id="Code{{this._id}}" required>
                        </div>
                        {{!-- Name --}}
                        <div class="col-md-8 mb-3">
                            <label for="Name">Tên vị trí , chức danh</label>
                            <input value="{{this.Name}}" name="Name" type="text" class="form-control"
                                id="Name{{this._id}}" required>
                            <span
                                style="color: #de2935;font-size: 14px;font-style: italic;margin-top: 5px;font-weight: 600;"
                                id="messageErrorUpdate{{this._id}}"></span>
                        </div>
                        {{!-- status --}}
                        <div class="custom-control custom-switch col-md-2"
                            style="display: flex; justify-content: center;align-items: center;">
                            {{#if this.IsManager}}
                            <input name="IsManager" type="checkbox" class="custom-control-input"
                                id="IsManager{{this._id}}" checked>
                            <label class="custom-control-label block" for="IsManager{{this._id}}">Quản lí</label>
                            {{else}}
                            <input name="IsManager" type="checkbox" class="custom-control-input"
                                id="IsManager{{this._id}}">
                            <label class="custom-control-label block" for="IsManager{{this._id}}">Quản lí</label>
                            {{/if}}
                        </div>
                        <div class="custom-control custom-switch col-md-2"
                            style="display: flex; justify-content: center;align-items: center;">
                            {{#if this.IsActive}}
                            <input name="IsActive" type="checkbox" class="custom-control-input"
                                id="IsActive{{this._id}}" checked>
                            <label class="custom-control-label block" for="IsActive{{this._id}}">Áp dụng</label>
                            {{else}}
                            <input name="IsActive" type="checkbox" class="custom-control-input"
                                id="IsActive{{this._id}}">
                            <label class="custom-control-label block" for="IsActive{{this._id}}">Áp dụng</label>
                            {{/if}}
                        </div>
                        {{!-- note --}}
                        <div class="col-md-8 mb-3 mt-3">
                            <label for="Note">Ghi
                                chú</label>
                            <input value="{{this.Note}}" name="Note" type="text" class="form-control"
                                id="Note{{this._id}}">
                        </div>
                    </div>
                </form>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                    <button onclick="handleUpdate('{{this._id}}')" class="btn btn-warning">Câp nhật</button>
                </div>
            </div>
        </div>
    </div>
</div>
{{/if}}
{{!-- POST --}}
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal__size" role="document">
        <div class="modal-content model__content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Thêm vị trí , chức danh</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" class="width: 100%">
                <form>
                    <div class="form-row">
                        {{!-- creatorUser --}}
                        <input type="text" name="CreatorUser_id" id="CreatorUser_id" value="{{User._id}}" hidden>
                        {{!-- code --}}
                        <div class="col-md-4 mb-3">
                            <label for="Code">Mã</label>
                            <input name="Code" type="text" class="form-control" id="code" required>
                        </div>
                        {{!-- name --}}
                        <div class="col-md-8 mb-3">
                            <label for="Name">Tên vị trí , chức danh</label>
                            <input name="Name" type="text" class="form-control" id="Name" required>
                            <span
                                style="color: #de2935;font-size: 14px;font-style: italic;margin-top: 5px;font-weight: 600;"
                                id="messageError"></span>
                        </div>
                        {{!-- status --}}
                        <div class="custom-control custom-switch col-md-2"
                            style="display: flex; justify-content: center;align-items: center;">
                            <input name="IsManager" type="checkbox" class="custom-control-input" id="IsManager">
                            <label class="custom-control-label block" for="IsManager">Quản lí</label>
                        </div>
                        <div class="custom-control custom-switch col-md-2"
                            style="display: flex; justify-content: center;align-items: center;">
                            <input name="IsActive" type="checkbox" class="custom-control-input" id="IsActive" checked>
                            <label class="custom-control-label block" for="IsActive">Áp dụng</label>
                        </div>
                        {{!-- note --}}
                        <div class="col-md-8 mb-3 mt-3">
                            <label for="Note">Ghi
                                chú</label>
                            <input name="Note" type="text" class="form-control" id="Note">
                        </div>
                    </div>
                </form>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                    <button onclick="handleAdd()" class="btn btn-info">Thêm</button>
                </div>
            </div>
        </div>
    </div>
</div>

{{!-- random code --}}
<script>
    function generateRandomCode(length) {
        let characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789';
        let code = '';
        for (let i = 0; i < length; i++) {
            code += characters.charAt(Math.floor(Math.random() * characters.length));
        }
        return code;
    }
    const codeRandom = generateRandomCode(8)
    const codeValue = document.querySelector("#code")
    codeValue.value = codeRandom
</script>

{{!-- acction req --}}
<script>
    async function handleAdd() {
        const code = document.getElementById("code").value
        const Name = document.getElementById("Name").value
        const IsManager = document.getElementById("IsManager").checked
        const IsActive = document.getElementById("IsActive").checked
        const Note = document.getElementById("Note").value
        const creatorUser_id = document.getElementById("CreatorUser_id").value
        if (Name.trim() === "") {
            $.toast({
                position: "top-right",
                heading: 'WARNING!',
                text: 'Tên không được để trống',
                icon: 'warning',
                loader: true,
                loaderBg: '#f2a654',
                showHideTransition: 'slide',
                stack: 4
            });
        }
        const form = {
            Code: code,
            Name: Name,
            CreatorUser_id: creatorUser_id,
            IsManager: IsManager === true ? 1 : 0,
            IsActive: IsActive === true ? 1 : 0,
            Note: Note
        }

        const res = await fetch("/workPosition/add", {
            method: "POST",
            body: JSON.stringify(form),
            headers: {
                "Content-Type": "application/json"
            }
        })
        if (res.ok) {
            const data = await res.json()
            localStorage.setItem('toast', JSON.stringify({
                position: "top-right",
                heading: 'Thêm thành công',
                text: 'Đã thêm thành công',
                icon: 'success',
                loader: true,
                loaderBg: '#9EC600',
                showHideTransition: 'slide',
                stack: 4
            }));
            window.location.replace("/workPosition")
        } else {
            const errorData = await res.json();
            $.toast({
                position: "top-right",
                heading: 'Thêm thất bại',
                text: errorData.message || 'Đã có lỗi xảy ra',
                icon: 'error',
                loader: true,
                loaderBg: '#f2a654',
                showHideTransition: 'slide',
                stack: 4
            });
        }
    }
    //update
    async function handleUpdate(id) {
        const code = document.getElementById(`Code${id}`).value
        const Name = document.getElementById(`Name${id}`).value
        const IsManager = document.getElementById(`IsManager${id}`).checked
        const IsActive = document.getElementById(`IsActive${id}`).checked
        const Note = document.getElementById(`Note${id}`).value
        const form = {
            Code: code,
            Name: Name,
            IsManager: IsManager === true ? 1 : 0,
            IsActive: IsActive === true ? 1 : 0,
            Note: Note
        }
        console.log(form)
        const res = await fetch(`/workPosition/update/${id}`, {
            method: "PATCH",
            body: JSON.stringify(form),
            headers: {
                "Content-Type": "application/json"
            }
        })
        if (res.ok) {
            const data = await res.json()
            localStorage.setItem('toast', JSON.stringify({
                position: "top-right",
                heading: 'SUCCESS',
                text: 'Đã cập nhật thành công',
                icon: 'success',
                loader: true,
                loaderBg: '#9EC600',
                showHideTransition: 'slide',
                stack: 4
            }));
            window.location.replace("/workPosition")
        } else {
            const data = await res.json()
            $.toast({
                position: "top-right",
                heading: 'Thêm thất bại',
                text: data.message || 'Đã có lỗi xảy ra',
                icon: 'error',
                loader: true,
                loaderBg: '#f2a654',
                showHideTransition: 'slide',
                stack: 4
            });
        }
    }
</script>